{"version":3,"file":"validation-workspace-context-CexQJ1Gg.js","sources":["../../../Client/src/validation/types.ts","../../../Client/src/validation/validation-api.service.ts","../../../Client/src/validation/validation-workspace-context.ts"],"sourcesContent":["// Enum for validation severity levels to match backend\r\nexport enum ValidationSeverity {\r\n    Error = 'Error',\r\n    Warning = 'Warning',\r\n    Info = 'Info'\r\n}\r\n\r\n// Type-safe literal types for notification colors\r\nexport type NotificationColor = 'danger' | 'warning' | 'default' | 'positive';\r\n\r\nexport interface ValidationMessage {\r\n    message: string;\r\n    severity: ValidationSeverity;\r\n}\r\n\r\nexport interface ValidationResult {\r\n    contentId: string;\r\n    hasValidator: boolean;\r\n    messages: ValidationMessage[];\r\n}\r\n","import type { ValidationResult } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\n\r\nexport class ValidationApiService extends UmbControllerBase {\r\n    private readonly baseUrl: string;\r\n    \r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n        this.baseUrl = `${window.location.origin}/umbraco/management/api/v1/validation`;\r\n    }\r\n    \r\n    /**\r\n     * Validates a document across multiple cultures\r\n     * @param id - Document identifier\r\n     * @param cultures - Array of culture codes to validate (undefined for invariant culture)\r\n     * @returns Validation results keyed by culture code\r\n     */\r\n    async validateDocumentMultipleCultures(\r\n        id: string, \r\n        cultures: (string | undefined)[]\r\n    ): Promise<Record<string, ValidationResult>> {\r\n        try {\r\n            const authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n            const token = await authContext?.getLatestToken();\r\n            \r\n            if (!token) {\r\n                throw new Error('Authentication token not available');\r\n            }\r\n            \r\n            const url = `${this.baseUrl}/validate/${encodeURIComponent(id)}`;\r\n            \r\n            const response = await fetch(url, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Authorization': `Bearer ${token}`,\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({ cultures }),\r\n            });\r\n            \r\n            if (!response.ok) {\r\n                const errorMessage = await this.extractErrorMessage(response);\r\n                throw new Error(errorMessage);\r\n            }\r\n            \r\n            const result = await response.json();\r\n            return result || {};\r\n            \r\n        } catch (error) {\r\n            return this.createFallbackResults(id, cultures, error);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Validates a document for a single culture\r\n     * @param id - Document identifier\r\n     * @param culture - Culture code (undefined for invariant culture)\r\n     * @returns Validation result for the specified culture\r\n     */\r\n    async validateDocument(id: string, culture?: string): Promise<ValidationResult> {\r\n        const results = await this.validateDocumentMultipleCultures(id, [culture]);\r\n        return results[culture || 'default'];\r\n    }\r\n    \r\n    /**\r\n     * Extracts error message from failed response\r\n     */\r\n    private async extractErrorMessage(response: Response): Promise<string> {\r\n        const defaultMessage = `Validation request failed: ${response.status} ${response.statusText}`;\r\n        \r\n        try {\r\n            const errorData = await response.json();\r\n            return errorData.detail || errorData.title || errorData.message || defaultMessage;\r\n        } catch {\r\n            return defaultMessage;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Creates fallback validation results when validation fails\r\n     */\r\n    private createFallbackResults(\r\n        id: string, \r\n        cultures: (string | undefined)[], \r\n        error: unknown\r\n    ): Record<string, ValidationResult> {\r\n        const errorMessage = error instanceof Error ? error.message : 'Unknown validation error';\r\n        const fallback: Record<string, ValidationResult> = {};\r\n        \r\n        for (const culture of cultures) {\r\n            const cultureKey = culture || 'default';\r\n            fallback[cultureKey] = {\r\n                contentId: id,\r\n                hasValidator: false,\r\n                messages: [{\r\n                    message: `Validation failed: ${errorMessage}`,\r\n                    severity: ValidationSeverity.Error\r\n                }]\r\n            };\r\n        }\r\n        \r\n        return fallback;\r\n    }\r\n}\r\n","import { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { ValidationApiService } from './validation-api.service.js';\r\nimport type { ValidationResult } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport { UmbObjectState, UmbNumberState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport class ValidationWorkspaceContext extends UmbContextBase {\r\n    #apiService = new ValidationApiService(this);\r\n    #validationResults = new Map<string, ValidationResult>();\r\n    #isValidating = new UmbObjectState<boolean>(false);\r\n\r\n    #counter = new UmbNumberState(0);\r\n\treadonly counter = this.#counter.asObservable();\r\n\r\n    public readonly isValidating = this.#isValidating.asObservable();\r\n\r\n    constructor(host: UmbControllerHost) {\r\n        super(host, VALIDATION_WORKSPACE_CONTEXT);\r\n    }\r\n\r\n    increment() {\r\n\t\tthis.#counter.setValue(this.#counter.value + 1);\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.#counter.setValue(0);\r\n\t}\r\n\r\n    /**\r\n     * Always use the multi-culture POST endpoint. If allCultures is omitted, validates current (single) culture.\r\n     * Results are stored per culture.\r\n     */\r\n    async validateManually(documentId: string, culture?: string, allCultures?: string[]): Promise<Record<string, ValidationResult>> {\r\n        this.#isValidating.setValue(true);\r\n        try {\r\n            const cultures = allCultures && allCultures.length > 0 ? allCultures : [culture];\r\n            const results = await this.#apiService.validateDocumentMultipleCultures(documentId, cultures);\r\n            for (const [cultureKey, result] of Object.entries(results)) {\r\n                this.#validationResults.set(cultureKey, result);\r\n            }\r\n            return results;\r\n        } catch (error) {\r\n            console.error('Manual validation failed:', error);\r\n            throw error;\r\n        } finally {\r\n            this.#isValidating.setValue(false);\r\n        }\r\n    }\r\n\r\n    getValidationResult(culture?: string): ValidationResult | undefined {\r\n        const cultureKey = culture || 'default';\r\n        return this.#validationResults.get(cultureKey);\r\n    }\r\n\r\n    hasBlockingErrors(culture?: string): boolean {\r\n        const cultureKey = culture || 'default';\r\n        const result = this.#validationResults.get(cultureKey);\r\n        if (!result) return false;\r\n        return result.messages.some(m => m.severity === ValidationSeverity.Error);\r\n    }\r\n\r\n    clearValidation() {\r\n        this.#validationResults.clear();\r\n    }\r\n}\r\n\r\nexport { ValidationWorkspaceContext as api };\r\n\r\nexport const VALIDATION_WORKSPACE_CONTEXT = new UmbContextToken<ValidationWorkspaceContext>(\r\n    'UmbWorkspaceContext',\r\n    'ValidationWorkspaceContext'\r\n);"],"names":["ValidationSeverity","ValidationApiService","UmbControllerBase","host","id","cultures","token","UMB_AUTH_CONTEXT","url","response","errorMessage","error","culture","defaultMessage","errorData","fallback","cultureKey","ValidationWorkspaceContext","UmbContextBase","VALIDATION_WORKSPACE_CONTEXT","#apiService","#validationResults","#isValidating","UmbObjectState","#counter","UmbNumberState","documentId","allCultures","results","result","m","UmbContextToken"],"mappings":"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"}