{"version":3,"file":"validation-workspace-context-C1nOTYt_.js","sources":["../../../Client/src/validation/types.ts","../../../Client/src/validation/validation-api.service.ts","../../../Client/src/validation/validation-workspace-context.ts"],"sourcesContent":["// Enum for validation severity levels to match backend\r\nexport enum ValidationSeverity {\r\n    Error = 'Error',\r\n    Warning = 'Warning',\r\n    Info = 'Info'\r\n}\r\n\r\n// Type-safe literal types for notification colors\r\nexport type NotificationColor = 'danger' | 'warning' | 'default' | 'positive';\r\n\r\nexport interface ValidationMessage {\r\n    message: string;\r\n    severity: ValidationSeverity;\r\n}\r\n\r\nexport interface ValidationResult {\r\n    contentId: string;\r\n    hasValidator: boolean;\r\n    messages: ValidationMessage[];\r\n}\r\n","import type { ValidationResult } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\n\r\nexport class ValidationApiService extends UmbControllerBase {\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n    }\r\n    \r\n    async validateDocumentMultipleCultures(id: string, cultures: (string | undefined)[]): Promise<Record<string, ValidationResult>> {\r\n        try {\r\n            const authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n            const token = await authContext?.getLatestToken();\r\n\r\n            const url = new URL(`/umbraco/management/api/v1/validation/validate/${id}`, window.location.origin);\r\n            const response = await fetch(url.toString(), {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Authorization': `Bearer ${token}`,\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({ cultures }),\r\n            });\r\n\r\n            if (!response.ok) {\r\n                let errorMessage = `Validation request failed: ${response.status} ${response.statusText}`;\r\n                try {\r\n                    const errorData = await response.json();\r\n                    if (errorData.detail) {\r\n                        errorMessage = errorData.detail;\r\n                    } else if (errorData.title) {\r\n                        errorMessage = errorData.title;\r\n                    } else if (errorData.message) {\r\n                        errorMessage = errorData.message;\r\n                    }\r\n                } catch {}\r\n                throw new Error(errorMessage);\r\n            }\r\n\r\n            const result = await response.json();\r\n            return result || {};\r\n        } catch (error) {\r\n            // Return a fallback error result for all requested cultures\r\n            const fallback: Record<string, ValidationResult> = {};\r\n            for (const culture of cultures) {\r\n                fallback[culture || 'default'] = {\r\n                    contentId: id,\r\n                    hasValidator: false,\r\n                    messages: [{ message: `Validation failed: ${(error as Error).message}`, severity: ValidationSeverity.Error }]\r\n                };\r\n            }\r\n            return fallback;\r\n        }\r\n    }\r\n\r\n    async validateDocument(id: string, culture?: string): Promise<ValidationResult> {\r\n        const results = await this.validateDocumentMultipleCultures(id, [culture]);\r\n        return results[culture || 'default'];\r\n    }\r\n}\r\n","import { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { ValidationApiService } from './validation-api.service.js';\r\nimport type { ValidationResult } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport { UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport const VALIDATION_WORKSPACE_CONTEXT = new UmbContextToken<ValidationWorkspaceContext>(\r\n    'ValidationWorkspaceContext'\r\n);\r\n\r\nexport class ValidationWorkspaceContext extends UmbControllerBase {\r\n    #apiService = new ValidationApiService(this);\r\n    #validationResults = new Map<string, ValidationResult>();\r\n    #isValidating = new UmbObjectState<boolean>(false);\r\n\r\n    public readonly isValidating = this.#isValidating.asObservable();\r\n\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n\r\n        this.provideContext(VALIDATION_WORKSPACE_CONTEXT, this);\r\n    }\r\n\r\n    /**\r\n     * Always use the multi-culture POST endpoint. If allCultures is omitted, validates current (single) culture.\r\n     * Results are stored per culture.\r\n     */\r\n    async validateManually(documentId: string, culture?: string, allCultures?: string[]): Promise<Record<string, ValidationResult>> {\r\n        this.#isValidating.setValue(true);\r\n        try {\r\n            const cultures = allCultures && allCultures.length > 0 ? allCultures : [culture];\r\n            const results = await this.#apiService.validateDocumentMultipleCultures(documentId, cultures);\r\n            for (const [cultureKey, result] of Object.entries(results)) {\r\n                this.#validationResults.set(cultureKey, result);\r\n            }\r\n            return results;\r\n        } catch (error) {\r\n            console.error('Manual validation failed:', error);\r\n            throw error;\r\n        } finally {\r\n            this.#isValidating.setValue(false);\r\n        }\r\n    }\r\n\r\n    getValidationResult(culture?: string): ValidationResult | undefined {\r\n        const cultureKey = culture || 'default';\r\n        return this.#validationResults.get(cultureKey);\r\n    }\r\n\r\n    hasBlockingErrors(culture?: string): boolean {\r\n        const cultureKey = culture || 'default';\r\n        const result = this.#validationResults.get(cultureKey);\r\n        if (!result) return false;\r\n        return result.messages.some(m => m.severity === ValidationSeverity.Error);\r\n    }\r\n\r\n    clearValidation() {\r\n        this.#validationResults.clear();\r\n    }\r\n}\r\n\r\nexport { ValidationWorkspaceContext as api };\r\n"],"names":["ValidationSeverity","ValidationApiService","UmbControllerBase","host","id","cultures","token","UMB_AUTH_CONTEXT","url","response","errorMessage","errorData","error","fallback","culture","VALIDATION_WORKSPACE_CONTEXT","UmbContextToken","ValidationWorkspaceContext","#apiService","#validationResults","#isValidating","UmbObjectState","documentId","allCultures","results","cultureKey","result","m"],"mappings":";;;;AACO,IAAKA,sBAAAA,OACRA,EAAA,QAAQ,SACRA,EAAA,UAAU,WACVA,EAAA,OAAO,QAHCA,IAAAA,KAAA,CAAA,CAAA;ACKL,MAAMC,UAA6BC,EAAkB;AAAA,EACxD,YAAYC,GAAyB;AACjC,UAAMA,CAAI;AAAA,EACd;AAAA,EAEA,MAAM,iCAAiCC,GAAYC,GAA6E;AAC5H,QAAI;AAEA,YAAMC,IAAQ,OADM,MAAM,KAAK,WAAWC,CAAgB,IACzB,eAAA,GAE3BC,IAAM,IAAI,IAAI,kDAAkDJ,CAAE,IAAI,OAAO,SAAS,MAAM,GAC5FK,IAAW,MAAM,MAAMD,EAAI,YAAY;AAAA,QACzC,QAAQ;AAAA,QACR,SAAS;AAAA,UACL,eAAiB,UAAUF,CAAK;AAAA,UAChC,gBAAgB;AAAA,QAAA;AAAA,QAEpB,MAAM,KAAK,UAAU,EAAE,UAAAD,GAAU;AAAA,MAAA,CACpC;AAED,UAAI,CAACI,EAAS,IAAI;AACd,YAAIC,IAAe,8BAA8BD,EAAS,MAAM,IAAIA,EAAS,UAAU;AACvF,YAAI;AACA,gBAAME,IAAY,MAAMF,EAAS,KAAA;AACjC,UAAIE,EAAU,SACVD,IAAeC,EAAU,SAClBA,EAAU,QACjBD,IAAeC,EAAU,QAClBA,EAAU,YACjBD,IAAeC,EAAU;AAAA,QAEjC,QAAQ;AAAA,QAAC;AACT,cAAM,IAAI,MAAMD,CAAY;AAAA,MAChC;AAGA,aADe,MAAMD,EAAS,KAAA,KACb,CAAA;AAAA,IACrB,SAASG,GAAO;AAEZ,YAAMC,IAA6C,CAAA;AACnD,iBAAWC,KAAWT;AAClB,QAAAQ,EAASC,KAAW,SAAS,IAAI;AAAA,UAC7B,WAAWV;AAAA,UACX,cAAc;AAAA,UACd,UAAU,CAAC,EAAE,SAAS,sBAAuBQ,EAAgB,OAAO,IAAI,UAAUZ,EAAmB,MAAA,CAAO;AAAA,QAAA;AAGpH,aAAOa;AAAA,IACX;AAAA,EACJ;AAAA,EAEA,MAAM,iBAAiBT,GAAYU,GAA6C;AAE5E,YADgB,MAAM,KAAK,iCAAiCV,GAAI,CAACU,CAAO,CAAC,GAC1DA,KAAW,SAAS;AAAA,EACvC;AACJ;ACrDO,MAAMC,IAA+B,IAAIC;AAAA,EAC5C;AACJ;AAEO,MAAMC,UAAmCf,EAAkB;AAAA,EAO9D,YAAYC,GAAyB;AACjC,UAAMA,CAAI,GAPd,KAAAe,KAAc,IAAIjB,EAAqB,IAAI,GAC3C,KAAAkB,yBAAyB,IAAA,GACzB,KAAAC,KAAgB,IAAIC,EAAwB,EAAK,GAEjD,KAAgB,eAAe,KAAKD,GAAc,aAAA,GAK9C,KAAK,eAAeL,GAA8B,IAAI;AAAA,EAC1D;AAAA,EAVAG;AAAA,EACAC;AAAA,EACAC;AAAA;AAAA;AAAA;AAAA;AAAA,EAcA,MAAM,iBAAiBE,GAAoBR,GAAkBS,GAAmE;AAC5H,SAAKH,GAAc,SAAS,EAAI;AAChC,QAAI;AACA,YAAMf,IAAWkB,KAAeA,EAAY,SAAS,IAAIA,IAAc,CAACT,CAAO,GACzEU,IAAU,MAAM,KAAKN,GAAY,iCAAiCI,GAAYjB,CAAQ;AAC5F,iBAAW,CAACoB,GAAYC,CAAM,KAAK,OAAO,QAAQF,CAAO;AACrD,aAAKL,GAAmB,IAAIM,GAAYC,CAAM;AAElD,aAAOF;AAAA,IACX,SAASZ,GAAO;AACZ,oBAAQ,MAAM,6BAA6BA,CAAK,GAC1CA;AAAA,IACV,UAAA;AACI,WAAKQ,GAAc,SAAS,EAAK;AAAA,IACrC;AAAA,EACJ;AAAA,EAEA,oBAAoBN,GAAgD;AAChE,UAAMW,IAAaX,KAAW;AAC9B,WAAO,KAAKK,GAAmB,IAAIM,CAAU;AAAA,EACjD;AAAA,EAEA,kBAAkBX,GAA2B;AACzC,UAAMW,IAAaX,KAAW,WACxBY,IAAS,KAAKP,GAAmB,IAAIM,CAAU;AACrD,WAAKC,IACEA,EAAO,SAAS,KAAK,OAAKC,EAAE,aAAa3B,EAAmB,KAAK,IADpD;AAAA,EAExB;AAAA,EAEA,kBAAkB;AACd,SAAKmB,GAAmB,MAAA;AAAA,EAC5B;AACJ;;;;;;;"}