{"version":3,"file":"validation-view.element-CNwZl5y6.js","sources":["../../../Client/src/validation/validation-view.element.ts"],"sourcesContent":["import { customElement, state, html, nothing, repeat, type PropertyValues } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { UMB_CONTENT_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/content';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport type { UmbWorkspaceViewElement } from '@umbraco-cms/backoffice/workspace';\r\nimport { VALIDATION_WORKSPACE_CONTEXT } from './validation-workspace-context.js';\r\nimport type { ValidationResult, ValidationMessage, NotificationColor } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\n\r\n// Typed constants for delays\r\nconst SAVE_DELAY_MS = 500;\r\nconst INITIAL_VALIDATION_DELAY_MS = 1000;\r\n\r\n// Type-safe severity order for sorting\r\nconst SEVERITY_ORDER: Record<ValidationSeverity, number> = {\r\n    [ValidationSeverity.Error]: 0,\r\n    [ValidationSeverity.Warning]: 1,\r\n    [ValidationSeverity.Info]: 2\r\n} as const;\r\n\r\n// Type-safe severity to color mapping\r\nconst SEVERITY_COLOR_MAP: Record<ValidationSeverity, NotificationColor> = {\r\n    [ValidationSeverity.Error]: 'danger',\r\n    [ValidationSeverity.Warning]: 'warning',\r\n    [ValidationSeverity.Info]: 'default'\r\n} as const;\r\n\r\n// Module-level map to track which documents+cultures have been validated\r\n// Key format: \"documentId|culture\" or \"documentId|undefined\" for invariant\r\nconst validatedDocuments = new Map<string, boolean>();\r\n\r\n// Track which instances are currently active in split view\r\n// Maps documentId to array of [instanceId, variantIndex] pairs\r\nconst splitViewInstances = new Map<string, Map<number, number>>();\r\nlet instanceCounter = 0;\r\n\r\n@customElement('custom-validator-workspace-view')\r\nexport class CustomValidatorWorkspaceView extends UmbLitElement implements UmbWorkspaceViewElement {\r\n    #instanceId: number;\r\n    @state()\r\n    private _documentId?: string;\r\n\r\n    @state()\r\n    private _validationResult?: ValidationResult;\r\n\r\n    @state()\r\n    private _isValidating = false;\r\n\r\n    @state()\r\n    private _currentCulture?: string;\r\n\r\n    @state()\r\n    private _cultureReady = false;\r\n\r\n    // Cached computed properties for performance (memoization)\r\n    @state()\r\n    private _sortedMessages?: ValidationMessage[];\r\n\r\n    @state()\r\n    private _messageCounts?: { errors: number; warnings: number };\r\n\r\n    #contentWorkspace?: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE;\r\n    #currentDocumentId?: string;\r\n\r\n    constructor() {\r\n        super();\r\n        \r\n        // Assign unique instance ID for debugging\r\n        this.#instanceId = instanceCounter++;\r\n\r\n        this.#setupWorkspaceObservers();\r\n        this.#setupValidationObservers();\r\n    }\r\n\r\n    #setupWorkspaceObservers() {\r\n        this.consumeContext(UMB_CONTENT_WORKSPACE_CONTEXT, (workspace) => {\r\n            if (!workspace) return;\r\n            this.#contentWorkspace = workspace;\r\n            this.#observeVariants(workspace);\r\n            this.#observeDocumentChanges(workspace);\r\n        });\r\n    }\r\n\r\n    #observeVariants(workspace: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE) {\r\n        // Observe the split view to know which variants are active\r\n        this.observe(\r\n            workspace.splitView.activeVariantsInfo,\r\n            async (variants) => {\r\n                if (!variants || variants.length === 0) {\r\n                    this._currentCulture = undefined;\r\n                    this._cultureReady = true;\r\n                    return;\r\n                }\r\n                \r\n                const docId = this._documentId || 'unknown';\r\n                let instanceMap = splitViewInstances.get(docId);\r\n                \r\n                if (variants.length > 1) {\r\n                    // Split view mode - register this instance\r\n                    if (!instanceMap) {\r\n                        instanceMap = new Map();\r\n                        splitViewInstances.set(docId, instanceMap);\r\n                    }\r\n                    \r\n                    // Assign variant index based on registration order in THIS split view session\r\n                    if (!instanceMap.has(this.#instanceId)) {\r\n                        const assignedIndex = instanceMap.size; // 0 for first, 1 for second\r\n                        instanceMap.set(this.#instanceId, assignedIndex);\r\n                    }\r\n                    \r\n                    const variantIndex = instanceMap.get(this.#instanceId)!;\r\n                    const variant = variants[variantIndex];\r\n                    const newCulture = variant?.culture ?? undefined;\r\n                    \r\n                    // Only update if culture actually changed\r\n                    if (this._currentCulture !== newCulture) {\r\n                        this._currentCulture = newCulture;\r\n                        this._cultureReady = true;\r\n                        await this.#loadCachedValidationResult();\r\n                    } else if (!this._cultureReady) {\r\n                        this._cultureReady = true;\r\n                    }\r\n                } else {\r\n                    // Single view mode - clear split view tracking\r\n                    if (instanceMap) {\r\n                        splitViewInstances.delete(docId);\r\n                    }\r\n                    \r\n                    const variant = variants[0];\r\n                    const newCulture = variant?.culture ?? undefined;\r\n                    \r\n                    if (this._currentCulture !== newCulture) {\r\n                        this._currentCulture = newCulture;\r\n                        this._cultureReady = true;\r\n                        await this.#loadCachedValidationResult();\r\n                    } else if (!this._cultureReady) {\r\n                        this._cultureReady = true;\r\n                    }\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    #getValidationKey(): string | undefined {\r\n        // Generate a unique key for tracking validation per document+culture\r\n        if (!this._documentId) return undefined;\r\n        return `${this._documentId}|${this._currentCulture ?? 'undefined'}`;\r\n    }\r\n\r\n    #observeDocumentChanges(workspace: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE) {\r\n        this.observe(\r\n            workspace.unique,\r\n            async (unique) => {\r\n                const isDocumentSwitch = this.#isDocumentSwitch(unique);\r\n                \r\n                this._documentId = unique ?? undefined;\r\n                this.#currentDocumentId = unique ?? undefined;\r\n\r\n                // Clear validation results when switching documents\r\n                await this.#clearValidationOnDocumentSwitch();\r\n                \r\n                // Only reset validation flags when truly switching between different documents\r\n                if (isDocumentSwitch && unique) {\r\n                    // Clear all validation flags for this document (all cultures)\r\n                    const keysToDelete = Array.from(validatedDocuments.keys()).filter(key => key.startsWith(`${unique}|`));\r\n                    keysToDelete.forEach(key => validatedDocuments.delete(key));\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    #isDocumentSwitch(newDocumentId: string | null | undefined): boolean {\r\n        return this.#currentDocumentId !== undefined && this.#currentDocumentId !== newDocumentId;\r\n    }\r\n\r\n    async #clearValidationOnDocumentSwitch() {\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (validationContext) {\r\n                validationContext.clearValidation();\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to clear validation on document switch:', error);\r\n        }\r\n    }\r\n\r\n    async #loadCachedValidationResult() {\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (validationContext) {\r\n                this._validationResult = validationContext.getValidationResult(this._currentCulture);\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to load cached validation result:', error);\r\n        }\r\n    }\r\n\r\n    #setupValidationObservers() {\r\n        this.consumeContext(VALIDATION_WORKSPACE_CONTEXT, (validationContext) => {\r\n            if (!validationContext) return;\r\n\r\n            this.observe(\r\n                validationContext.isValidating,\r\n                (isValidating) => {\r\n                    this._isValidating = isValidating;\r\n                }\r\n            );\r\n        });\r\n    }\r\n\r\n    override willUpdate(changedProperties: PropertyValues) {\r\n        super.willUpdate(changedProperties);\r\n        \r\n        // Recalculate cached computed properties when validation result changes\r\n        if (changedProperties.has('_validationResult')) {\r\n            this._sortedMessages = this.#sortMessagesBySeverity();\r\n            this._messageCounts = this.#getMessageCounts();\r\n        }\r\n    }\r\n\r\n    override connectedCallback() {\r\n        super.connectedCallback();\r\n        \r\n        // In split view, wait for culture to be ready before initial validation\r\n        // The #observeVariants will trigger validation once culture is set\r\n        if (!this._cultureReady) {\r\n            return;\r\n        }\r\n        \r\n        const validationKey = this.#getValidationKey();\r\n        const hasValidatedOnce = validationKey ? validatedDocuments.get(validationKey) ?? false : false;\r\n        \r\n        // Validate when tab becomes visible\r\n        if (this._documentId) {\r\n            if (!hasValidatedOnce) {\r\n                if (validationKey) {\r\n                    validatedDocuments.set(validationKey, true);\r\n                }\r\n                // Skip save on initial load to avoid triggering save modal\r\n                this.#validateAndUpdateResult({ useDelay: true, skipSave: true });\r\n            } else {\r\n                this.#validateAndUpdateResult({ skipSave: true });\r\n            }\r\n        }\r\n    }\r\n\r\n    override disconnectedCallback() {\r\n        super.disconnectedCallback();\r\n        // Clean up cached state when component is removed\r\n        this._sortedMessages = undefined;\r\n        this._messageCounts = undefined;\r\n        \r\n        // Clean up split view tracking for this instance\r\n        if (this._documentId) {\r\n            const instanceMap = splitViewInstances.get(this._documentId);\r\n            if (instanceMap) {\r\n                instanceMap.delete(this.#instanceId);\r\n                if (instanceMap.size === 0) {\r\n                    splitViewInstances.delete(this._documentId);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Unified validation method replacing all duplicate validation logic\r\n    async #validateAndUpdateResult(options: { useDelay?: boolean; skipSave?: boolean } = {}) {\r\n        if (!this._documentId) return;\r\n        if (this._validationResult?.hasValidator === false) return;\r\n\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (!validationContext) return;\r\n\r\n            const performValidation = async () => {\r\n                try {\r\n                    // Save before validation unless explicitly skipped\r\n                    if (!options.skipSave && this.#contentWorkspace?.requestSubmit) {\r\n                        await this.#contentWorkspace.requestSubmit();\r\n                        await this.#delay(SAVE_DELAY_MS);\r\n                    }\r\n                    \r\n                    await validationContext.validateManually(this._documentId!, this._currentCulture);\r\n                    this._validationResult = validationContext.getValidationResult(this._currentCulture);\r\n                } catch (error) {\r\n                    console.debug('Validation skipped:', error);\r\n                }\r\n            };\r\n\r\n            // Use delay for initial validation to ensure workspace is fully loaded\r\n            if (options.useDelay) {\r\n                await this.#delay(INITIAL_VALIDATION_DELAY_MS);\r\n            }\r\n            \r\n            await performValidation();\r\n        } catch (error) {\r\n            console.error('Failed to validate and update result:', error);\r\n        }\r\n    }\r\n\r\n    #handleValidateClick = async () => {\r\n        await this.#validateAndUpdateResult();\r\n    };\r\n\r\n    #handleSaveAndPublishClick = async () => {\r\n        if (!this._documentId) return;\r\n        if (this._validationResult?.hasValidator === false) return;\r\n\r\n        try {\r\n            // Validate first\r\n            await this.#validateAndUpdateResult();\r\n\r\n            // Check for blocking errors\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (validationContext?.hasBlockingErrors(this._currentCulture)) {\r\n                await this.#showNotification('danger', 'Cannot Publish', 'Validation errors must be resolved first');\r\n                return;\r\n            }\r\n\r\n            // Publish if no errors\r\n            await this.#publishDocument();\r\n        } catch (error) {\r\n            await this.#showNotification(\r\n                'danger',\r\n                'Error',\r\n                error instanceof Error ? error.message : 'Save and publish failed'\r\n            );\r\n        }\r\n    };\r\n\r\n    // Typed utility helpers\r\n    #sortMessagesBySeverity(): ValidationMessage[] | undefined {\r\n        if (!this._validationResult?.messages) return undefined;\r\n        return [...this._validationResult.messages].sort((a, b) => \r\n            SEVERITY_ORDER[a.severity] - SEVERITY_ORDER[b.severity]\r\n        );\r\n    }\r\n\r\n    #getMessageCounts(): { errors: number; warnings: number } {\r\n        if (!this._validationResult) {\r\n            return { errors: 0, warnings: 0 };\r\n        }\r\n        return {\r\n            errors: this._validationResult.messages.filter(m => m.severity === ValidationSeverity.Error).length,\r\n            warnings: this._validationResult.messages.filter(m => m.severity === ValidationSeverity.Warning).length\r\n        };\r\n    }\r\n\r\n    #hasErrorsOrWarnings(): boolean {\r\n        return this._validationResult?.messages.some(\r\n            m => m.severity === ValidationSeverity.Error || m.severity === ValidationSeverity.Warning\r\n        ) ?? false;\r\n    }\r\n\r\n    async #showNotification(color: NotificationColor, headline: string, message: string) {\r\n        try {\r\n            const notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n            notificationContext?.peek(color, {\r\n                data: { headline, message }\r\n            });\r\n        } catch (error) {\r\n            console.error('Failed to show notification:', error);\r\n        }\r\n    }\r\n\r\n    async #publishDocument() {\r\n        try {\r\n            if (this.#contentWorkspace && 'publish' in this.#contentWorkspace && typeof this.#contentWorkspace.publish === 'function') {\r\n                await this.#contentWorkspace.publish();\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to publish document:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    #delay(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    #getSeverityColor(severity: ValidationSeverity): NotificationColor {\r\n        return SEVERITY_COLOR_MAP[severity];\r\n    }\r\n\r\n    #renderValidationResults() {\r\n        if (this._isValidating || !this._validationResult) {\r\n            return this.#renderLoadingState();\r\n        }\r\n\r\n        if (!this._validationResult.hasValidator) {\r\n            return this.#renderNoValidatorState();\r\n        }\r\n\r\n        return html`\r\n            <uui-box headline=\"Validation Results\" headline-variant=\"h5\">\r\n                ${!this.#hasErrorsOrWarnings() ? this.#renderSuccessMessage() : nothing}\r\n                <uui-table aria-label=\"Validation Messages\">\r\n                    <uui-table-head>\r\n                        <uui-table-head-cell style=\"width: 120px;\">Severity</uui-table-head-cell>\r\n                        <uui-table-head-cell>Message</uui-table-head-cell>\r\n                    </uui-table-head>\r\n                    ${repeat(\r\n                        this._sortedMessages ?? [],\r\n                        (msg) => msg.message,\r\n                        (msg) => html`\r\n                            <uui-table-row>\r\n                                <uui-table-cell>\r\n                                    <uui-tag color=${this.#getSeverityColor(msg.severity)} look=\"primary\">\r\n                                        ${msg.severity}\r\n                                    </uui-tag>\r\n                                </uui-table-cell>\r\n                                <uui-table-cell>${msg.message}</uui-table-cell>\r\n                            </uui-table-row>\r\n                        `\r\n                    )}\r\n                </uui-table>\r\n            </uui-box>\r\n        `;\r\n    }\r\n\r\n    #renderLoadingState() {\r\n        return html`\r\n            <uui-box headline=\"Status\" headline-variant=\"h5\">\r\n                <div style=\"display: flex; align-items: center; gap: var(--uui-size-space-3);\">\r\n                    <uui-loader></uui-loader>\r\n                    <span>Validating...</span>\r\n                </div>\r\n            </uui-box>\r\n        `;\r\n    }\r\n\r\n    #renderNoValidatorState() {\r\n        return html`\r\n            <uui-box headline=\"Status\" headline-variant=\"h5\">\r\n                <p>No validation configured for this content type (${this._validationResult?.contentTypeAlias}).</p>\r\n            </uui-box>\r\n        `;\r\n    }\r\n\r\n    #renderSuccessMessage() {\r\n        return html`\r\n            <p style=\"color: var(--uui-color-positive);\">\r\n                <uui-icon name=\"icon-check\"></uui-icon>\r\n                All validations passed successfully.\r\n            </p>\r\n        `;\r\n    }\r\n\r\n    #renderHeader() {\r\n        const { errors, warnings } = this._messageCounts ?? { errors: 0, warnings: 0 };\r\n\r\n        return html`\r\n            <div slot=\"headline\">\r\n                ${this.#renderHeaderIcon(errors)}\r\n                Document Validation\r\n            </div>\r\n            <div slot=\"header-actions\">\r\n                ${errors > 0 ? html`\r\n                    <uui-tag color=\"danger\" look=\"primary\">${errors}</uui-tag>\r\n                ` : nothing}\r\n                ${warnings > 0 ? html`\r\n                    <uui-tag color=\"warning\" look=\"primary\">${warnings}</uui-tag>\r\n                ` : nothing}\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    #renderHeaderIcon(errorCount: number) {\r\n        return errorCount > 0 \r\n            ? html`<uui-icon name=\"icon-delete\" style=\"color: var(--uui-color-danger);\"></uui-icon>`\r\n            : html`<uui-icon name=\"icon-check\" style=\"color: var(--uui-color-positive);\"></uui-icon>`;\r\n    }\r\n\r\n    #renderControls() {\r\n        return html`\r\n            <uui-button-group>\r\n                <uui-button\r\n                    look=\"primary\"\r\n                    color=\"default\"\r\n                    label=\"Save & Validate\"\r\n                    @click=${this.#handleValidateClick}\r\n                    ?disabled=${!this._documentId || this._isValidating}>\r\n                    Save & Validate\r\n                </uui-button>\r\n                <uui-button\r\n                    look=\"primary\"\r\n                    color=\"positive\"\r\n                    label=\"Validate & Publish\"\r\n                    @click=${this.#handleSaveAndPublishClick}\r\n                    ?disabled=${!this._documentId || this._isValidating}>\r\n                    Validate & Publish\r\n                </uui-button>\r\n                ${this._isValidating ? html`<uui-loader></uui-loader>` : nothing}\r\n            </uui-button-group>\r\n        `;\r\n    }\r\n\r\n    override render() {\r\n        const shouldShowControls = this._validationResult?.hasValidator !== false && this._validationResult !== undefined;\r\n        \r\n        return html`\r\n            <umb-body-layout header-transparent header-fit-height>\r\n                <div style=\"display: flex; flex-direction: column; gap: var(--uui-size-layout-1);\">\r\n                    ${shouldShowControls ? html`\r\n                        <uui-box headline-variant=\"h4\">\r\n                            ${this.#renderHeader()}\r\n                            ${this.#renderControls()}\r\n                        </uui-box>\r\n                    ` : nothing}\r\n\r\n                    ${this.#renderValidationResults()}\r\n                </div>\r\n            </umb-body-layout>\r\n        `;\r\n    }\r\n\r\n    static override styles = [UmbTextStyles];\r\n}\r\n\r\nexport { CustomValidatorWorkspaceView as element };\r\n\r\ndeclare global {\r\n    interface HTMLElementTagNameMap {\r\n        'custom-validator-workspace-view': CustomValidatorWorkspaceView;\r\n    }\r\n}\r\n"],"names":["_instanceId","_contentWorkspace","_currentDocumentId","_CustomValidatorWorkspaceView_instances","setupWorkspaceObservers_fn","observeVariants_fn","getValidationKey_fn","observeDocumentChanges_fn","isDocumentSwitch_fn","clearValidationOnDocumentSwitch_fn","loadCachedValidationResult_fn","setupValidationObservers_fn","validateAndUpdateResult_fn","_handleValidateClick","_handleSaveAndPublishClick","sortMessagesBySeverity_fn","getMessageCounts_fn","hasErrorsOrWarnings_fn","showNotification_fn","publishDocument_fn","delay_fn","getSeverityColor_fn","renderValidationResults_fn","renderLoadingState_fn","renderNoValidatorState_fn","renderSuccessMessage_fn","renderHeader_fn","renderHeaderIcon_fn","renderControls_fn","SAVE_DELAY_MS","INITIAL_VALIDATION_DELAY_MS","SEVERITY_ORDER","ValidationSeverity","SEVERITY_COLOR_MAP","validatedDocuments","splitViewInstances","instanceCounter","CustomValidatorWorkspaceView","UmbLitElement","__privateAdd","__privateMethod","VALIDATION_WORKSPACE_CONTEXT","error","__privateSet","changedProperties","validationKey","hasValidatedOnce","instanceMap","__privateGet","shouldShowControls","html","nothing","UMB_CONTENT_WORKSPACE_CONTEXT","workspace","variants","docId","assignedIndex","variantIndex","newCulture","unique","isDocumentSwitch","key","newDocumentId","validationContext","isValidating","options","performValidation","a","b","m","color","headline","message","UMB_NOTIFICATION_CONTEXT","ms","resolve","severity","repeat","msg","errors","warnings","errorCount","UmbTextStyles","__decorateClass","state","customElement"],"mappings":"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"}