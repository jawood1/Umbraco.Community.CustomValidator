{"version":3,"file":"validation-view.element-E9Yq-3SM.js","sources":["../../../Client/src/validation/validation-view.element.ts"],"sourcesContent":["import { customElement, state, html, nothing, repeat, type PropertyValues } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { UMB_CONTENT_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/content';\r\nimport type { UmbWorkspaceViewElement } from '@umbraco-cms/backoffice/workspace';\r\nimport { VALIDATION_WORKSPACE_CONTEXT } from './validation-workspace-context.js';\r\nimport type { ValidationResult, ValidationMessage, NotificationColor } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\n\r\n// Typed constants for delays\r\nconst SAVE_DELAY_MS = 500;\r\nconst INITIAL_VALIDATION_DELAY_MS = 1000;\r\n\r\n// Type-safe severity order for sorting\r\nconst SEVERITY_ORDER: Record<ValidationSeverity, number> = {\r\n    [ValidationSeverity.Error]: 0,\r\n    [ValidationSeverity.Warning]: 1,\r\n    [ValidationSeverity.Info]: 2\r\n} as const;\r\n\r\n// Type-safe severity to color mapping\r\nconst SEVERITY_COLOR_MAP: Record<ValidationSeverity, NotificationColor> = {\r\n    [ValidationSeverity.Error]: 'danger',\r\n    [ValidationSeverity.Warning]: 'warning',\r\n    [ValidationSeverity.Info]: 'default'\r\n} as const;\r\n\r\n// Module-level map to track which documents+cultures have been validated\r\n// Key format: \"documentId|culture\" or \"documentId|undefined\" for invariant\r\nconst validatedDocuments = new Map<string, boolean>();\r\n\r\n// Static array to track registration order of instances for split view\r\n// const splitViewInstanceOrder: CustomValidatorWorkspaceView[] = [];\r\n\r\n@customElement('custom-validator-workspace-view')\r\nexport class CustomValidatorWorkspaceView extends UmbLitElement implements UmbWorkspaceViewElement {\r\n    #countContext?: typeof VALIDATION_WORKSPACE_CONTEXT.TYPE;\r\n    \r\n    @state()\r\n    private count = 0;\r\n    \r\n    @state()\r\n    private _documentId?: string;\r\n    \r\n    @state()\r\n    private _validationResults: Record<string, ValidationResult> = {};\r\n    \r\n    @state()\r\n    private _activeCulture?: string;\r\n    \r\n    @state()\r\n    private _isValidating = false;\r\n    \r\n    @state()\r\n    private _currentCulture?: string;\r\n    \r\n    @state()\r\n    private _cultureReady = false;\r\n    \r\n    #contentWorkspace?: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE;\r\n    #currentDocumentId?: string;\r\n    #variantObserverSetup = false;\r\n    \r\n    constructor() {\r\n        super();\r\n    \r\n        this.consumeContext(VALIDATION_WORKSPACE_CONTEXT, (instance) => {\r\n            if (!instance) return;\r\n            \r\n            this.#countContext = instance;\r\n            this.#observeCounter();\r\n            instance.increment();\r\n        });\r\n        \r\n        this.#setupWorkspaceObservers();\r\n        this.#setupValidationObservers();\r\n        window.addEventListener('custom-validator:validate-all', this.#onGlobalValidateAll);\r\n    }\r\n    \r\n    #observeCounter(): void {\r\n        if (!this.#countContext) return;\r\n        this.observe(this.#countContext.counter, (count) => {\r\n            // Convert 1-based counter to 0-based index\r\n            this.count = count - 1;\r\n            console.log('Instance index:', this.count, '(from counter:', count + ')');\r\n            \r\n            // Try to set up variant observer once we have the count\r\n            this.#trySetupVariantObserver();\r\n        });\r\n    }\r\n    \r\n    #setupWorkspaceObservers() {\r\n        this.consumeContext(UMB_CONTENT_WORKSPACE_CONTEXT, (workspace) => {\r\n            if (!workspace) return;\r\n            this.#contentWorkspace = workspace;\r\n            this.#observeDocumentChanges(workspace);\r\n            \r\n            // Try to set up variant observer once we have the workspace\r\n            this.#trySetupVariantObserver();\r\n        });\r\n    }\r\n    \r\n    #trySetupVariantObserver() {\r\n        // Only set up once, and only when both workspace and count are ready\r\n        if (this.#variantObserverSetup || !this.#contentWorkspace || this.count < 0) {\r\n            return;\r\n        }\r\n        \r\n        this.#variantObserverSetup = true;\r\n        console.log('Setting up variant observer for instance:', this.count);\r\n        this.#observeVariant(this.#contentWorkspace);\r\n    }\r\n    \r\n    #observeVariant(workspace: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE) {\r\n        console.log('Observing variant at index:', this.count);\r\n        \r\n        // Observe the variant for this specific instance (counter-based)\r\n        this.observe(\r\n            workspace.splitView.activeVariantByIndex(this.count),\r\n            async (variant) => {\r\n                const newCulture = variant?.culture ?? undefined;\r\n                console.log(`Instance ${this.count} - Culture:`, newCulture, 'Variant:', variant);\r\n                \r\n                // Only update and reload if culture actually changed\r\n                if (this._currentCulture !== newCulture) {\r\n                    this._currentCulture = newCulture;\r\n                    this._cultureReady = true;\r\n                    await this.#loadCachedValidationResult();\r\n                } else if (!this._cultureReady) {\r\n                    this._cultureReady = true;\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    #getValidationKey(): string | undefined {\r\n        // Generate a unique key for tracking validation per document+culture\r\n        if (!this._documentId) return undefined;\r\n        return `${this._documentId}|${this._currentCulture ?? 'undefined'}`;\r\n    }\r\n\r\n    #observeDocumentChanges(workspace: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE) {\r\n        this.observe(\r\n            workspace.unique,\r\n            async (unique) => {\r\n                const isDocumentSwitch = this.#isDocumentSwitch(unique);\r\n                \r\n                this._documentId = unique ?? undefined;\r\n                this.#currentDocumentId = unique ?? undefined;\r\n\r\n                // Clear validation results when switching documents\r\n                await this.#clearValidationOnDocumentSwitch();\r\n                \r\n                // Only reset validation flags when truly switching between different documents\r\n                if (isDocumentSwitch && unique) {\r\n                    // Clear all validation flags for this document (all cultures)\r\n                    const keysToDelete = Array.from(validatedDocuments.keys()).filter(key => key.startsWith(`${unique}|`));\r\n                    keysToDelete.forEach(key => validatedDocuments.delete(key));\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    #isDocumentSwitch(newDocumentId: string | null | undefined): boolean {\r\n        return this.#currentDocumentId !== undefined && this.#currentDocumentId !== newDocumentId;\r\n    }\r\n\r\n    async #clearValidationOnDocumentSwitch() {\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (validationContext) {\r\n                validationContext.clearValidation();\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to clear validation on document switch:', error);\r\n        }\r\n    }\r\n\r\n    async #loadCachedValidationResult() {\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (validationContext) {\r\n                // Load all cached results for all cultures\r\n                const cultures = Object.keys(this._validationResults);\r\n                const results: Record<string, ValidationResult> = {};\r\n                for (const culture of cultures) {\r\n                    const result = validationContext.getValidationResult(culture === 'default' ? undefined : culture);\r\n                    if (result) results[culture] = result;\r\n                }\r\n                this._validationResults = results;\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to load cached validation result:', error);\r\n        }\r\n    }\r\n\r\n    #setupValidationObservers() {\r\n        this.consumeContext(VALIDATION_WORKSPACE_CONTEXT, (validationContext) => {\r\n            if (!validationContext) return;\r\n\r\n            this.observe(\r\n                validationContext.isValidating,\r\n                (isValidating) => {\r\n                    this._isValidating = isValidating;\r\n                }\r\n            );\r\n        });\r\n    }\r\n\r\n    override willUpdate(changedProperties: PropertyValues) {\r\n        super.willUpdate(changedProperties);\r\n        \r\n        // Recalculate cached computed properties when validation result changes\r\n        if (changedProperties.has('_validationResult')) {\r\n        }\r\n    }\r\n\r\n    override connectedCallback() {\r\n        super.connectedCallback();\r\n        \r\n        // In split view, wait for culture to be ready before initial validation\r\n        // The #observeVariants will trigger validation once culture is set\r\n        if (!this._cultureReady) {\r\n            return;\r\n        }\r\n        \r\n        const validationKey = this.#getValidationKey();\r\n        const hasValidatedOnce = validationKey ? validatedDocuments.get(validationKey) ?? false : false;\r\n        \r\n        // Validate when tab becomes visible\r\n        if (this._documentId) {\r\n            if (!hasValidatedOnce) {\r\n                if (validationKey) {\r\n                    validatedDocuments.set(validationKey, true);\r\n                }\r\n                // Skip save on initial load to avoid triggering save modal\r\n                this.#validateAndUpdateResult({ useDelay: true, skipSave: true });\r\n            } else {\r\n                this.#validateAndUpdateResult({ skipSave: true });\r\n            }\r\n        }\r\n    }\r\n\r\n    override disconnectedCallback() {\r\n        super.disconnectedCallback();\r\n        window.removeEventListener('custom-validator:validate-all', this.#onGlobalValidateAll);\r\n        \r\n        // Type-safe reset\r\n        if (this.#countContext) {\r\n            this.#countContext.reset();\r\n        }\r\n    }\r\n\r\n    // Unified validation method for all cultures\r\n    async #validateAndUpdateResult(options: { useDelay?: boolean; skipSave?: boolean } = {}) {\r\n        if (!this._documentId) return;\r\n\r\n        try {\r\n            const validationContext = await this.getContext(VALIDATION_WORKSPACE_CONTEXT);\r\n            if (!validationContext) return;\r\n\r\n            const performValidation = async () => {\r\n                try {\r\n                    // Save before validation unless explicitly skipped\r\n                    if (!options.skipSave && this.#contentWorkspace?.requestSubmit) {\r\n                        await this.#contentWorkspace.requestSubmit();\r\n                        await this.#delay(SAVE_DELAY_MS);\r\n                    }\r\n\r\n                    // Detect split view: if more than one variant, validate all cultures at once\r\n                    let allCultures: string[] | undefined = undefined;\r\n                    const splitView = this.#contentWorkspace?.splitView;\r\n                    let variants: any[] = [];\r\n                    if (splitView && typeof splitView.activeVariantsInfo.subscribe === 'function') {\r\n                        // Synchronously get the current value of the observable\r\n                        splitView.activeVariantsInfo.subscribe((val: any[]) => { variants = val; }) ;\r\n                    }\r\n                    if (variants.length > 1) {\r\n                        allCultures = variants.map((v: any) => v.culture ?? undefined);\r\n                    }\r\n\r\n                    const results = await validationContext.validateManually(this._documentId!, this._currentCulture, allCultures);\r\n                    this._validationResults = results;\r\n                    // Set active culture for rendering\r\n                    this._activeCulture = this._currentCulture ?? 'default';\r\n                } catch (error) {\r\n                    console.debug('Validation skipped:', error);\r\n                }\r\n            };\r\n\r\n            // Use delay for initial validation to ensure workspace is fully loaded\r\n            if (options.useDelay) {\r\n                await this.#delay(INITIAL_VALIDATION_DELAY_MS);\r\n            }\r\n\r\n            await performValidation();\r\n        } catch (error) {\r\n            console.error('Failed to validate and update result:', error);\r\n        }\r\n    }\r\n\r\n    #handleValidateClick = async () => {\r\n        // Validate this pane with save\r\n        await this.#validateAndUpdateResult({ skipSave: false });\r\n        // Dispatch global event so all panes validate (but skip save in others)\r\n        window.dispatchEvent(new CustomEvent('custom-validator:validate-all', { detail: { skipSave: true } }));\r\n    };\r\n\r\n    #onGlobalValidateAll = async (event: Event) => {\r\n        // Only validate if this pane is attached and has a document\r\n        if (this.isConnected && this._documentId) {\r\n            // If event has detail.skipSave, use it; otherwise default to true\r\n            let skipSave = true;\r\n            if (event instanceof CustomEvent && typeof event.detail?.skipSave === 'boolean') {\r\n                skipSave = event.detail.skipSave;\r\n            }\r\n            await this.#validateAndUpdateResult({ skipSave });\r\n        }\r\n    }\r\n\r\n    #getMessageCounts(cultures?: string[]): { errors: number; warnings: number } {\r\n        // If cultures not provided, use all keys in _validationResults\r\n        const toCount = cultures && cultures.length > 0 ? cultures : Object.keys(this._validationResults);\r\n        let errors = 0;\r\n        let warnings = 0;\r\n        for (const culture of toCount) {\r\n            const result = this._validationResults[culture];\r\n            if (result) {\r\n                errors += result.messages.filter((m: ValidationMessage) => m.severity === ValidationSeverity.Error).length;\r\n                warnings += result.messages.filter((m: ValidationMessage) => m.severity === ValidationSeverity.Warning).length;\r\n            }\r\n        }\r\n        return { errors, warnings };\r\n    }\r\n\r\n    #delay(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    #getSeverityColor(severity: ValidationSeverity): NotificationColor {\r\n        return SEVERITY_COLOR_MAP[severity];\r\n    }\r\n\r\n    #renderValidationResults() {\r\n        if (this._isValidating) {\r\n            return this.#renderLoadingState();\r\n        }\r\n        const cultures = Object.keys(this._validationResults);\r\n        if (cultures.length === 0) {\r\n            return this.#renderLoadingState();\r\n        }\r\n        // In split view, show all cultures; in single view, show only the active culture\r\n        const toRender = cultures.length > 1 ? cultures : [this._activeCulture ?? 'default'];\r\n        return html`\r\n            <div style=\"display: flex; gap: var(--uui-size-layout-1); flex-direction: column;\">\r\n                ${toRender.map(culture => {\r\n                    const result = this._validationResults[culture];\r\n                    if (!result) return nothing;\r\n                    if (!result.hasValidator) {\r\n                        return html`\r\n                        <uui-box headline=\"Status\" headline-variant=\"h5\">\r\n                            <p>No custom validation configured for this document.</p>\r\n                        </uui-box>`;\r\n                    }\r\n                    const sortedMessages = [...result.messages].sort((a, b) => SEVERITY_ORDER[a.severity] - SEVERITY_ORDER[b.severity]);\r\n                    const hasErrorsOrWarnings = result.messages.some(m => m.severity === ValidationSeverity.Error || m.severity === ValidationSeverity.Warning);\r\n                    return html`\r\n                        <uui-box headline=\"Validation Results\" headline-variant=\"h5\">\r\n\r\n                            ${culture !== \"default\" ? html`\r\n                                <div slot=\"header-actions\">\r\n                                    <uui-tag color=\"default\" look=\"primary\">${culture}</uui-tag>\r\n                                </div>` \r\n                            : nothing}\r\n\r\n                            ${!hasErrorsOrWarnings ? this.#renderSuccessMessage() : nothing}\r\n                            <uui-table aria-label=\"Validation Messages\">\r\n                                <uui-table-head>\r\n                                    <uui-table-head-cell style=\"width: 120px;\">Severity</uui-table-head-cell>\r\n                                    <uui-table-head-cell>Message</uui-table-head-cell>\r\n                                </uui-table-head>\r\n                                ${repeat(\r\n                                    sortedMessages,\r\n                                    (msg) => msg.message,\r\n                                    (msg) => html`\r\n                                        <uui-table-row>\r\n                                            <uui-table-cell>\r\n                                                <uui-tag color=${this.#getSeverityColor(msg.severity)} look=\"primary\">\r\n                                                    ${msg.severity}\r\n                                                </uui-tag>\r\n                                            </uui-table-cell>\r\n                                            <uui-table-cell>${msg.message}</uui-table-cell>\r\n                                        </uui-table-row>\r\n                                    `\r\n                                )}\r\n                            </uui-table>\r\n                        </uui-box>\r\n                    `;\r\n                })}\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    #renderLoadingState() {\r\n        return html`\r\n            <uui-box headline=\"Status\" headline-variant=\"h5\">\r\n                <div style=\"display: flex; align-items: center; gap: var(--uui-size-space-3);\">\r\n                    <uui-loader></uui-loader>\r\n                    <span>Validating...</span>\r\n                </div>\r\n            </uui-box>\r\n        `;\r\n    }\r\n\r\n    #renderSuccessMessage() {\r\n        return html`\r\n            <p style=\"color: var(--uui-color-positive);\">\r\n                <uui-icon name=\"icon-check\"></uui-icon>\r\n                All validations passed successfully.\r\n            </p>\r\n        `;\r\n    }\r\n\r\n    #renderHeader() {\r\n        // Show counts for all rendered cultures (split or single view)\r\n        const cultures = Object.keys(this._validationResults);\r\n        const toRender = cultures.length > 1 ? cultures : [this._activeCulture ?? 'default'];\r\n        const { errors, warnings } = this.#getMessageCounts(toRender);\r\n\r\n        return html`\r\n            <div slot=\"headline\">\r\n                ${this.#renderHeaderIcon(errors)}\r\n                Document Validation\r\n            </div>\r\n            <div slot=\"header-actions\">\r\n                ${errors > 0 ? html`\r\n                    <uui-tag color=\"danger\" look=\"primary\">${errors}</uui-tag>\r\n                ` : nothing}\r\n                ${warnings > 0 ? html`\r\n                    <uui-tag color=\"warning\" look=\"primary\">${warnings}</uui-tag>\r\n                ` : nothing}\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    #renderHeaderIcon(errorCount: number) {\r\n        return errorCount > 0 \r\n            ? html`<uui-icon name=\"icon-delete\" style=\"color: var(--uui-color-danger);\"></uui-icon>`\r\n            : html`<uui-icon name=\"icon-check\" style=\"color: var(--uui-color-positive);\"></uui-icon>`;\r\n    }\r\n\r\n    #renderControls() {\r\n        return html`\r\n            <uui-button-group>\r\n                <uui-button\r\n                    look=\"primary\"\r\n                    color=\"default\"\r\n                    label=\"Save & Validate\"\r\n                    @click=${this.#handleValidateClick}\r\n                    ?disabled=${!this._documentId || this._isValidating}>\r\n                    Save & Validate\r\n                </uui-button>\r\n                ${this._isValidating ? html`<uui-loader></uui-loader>` : nothing}\r\n            </uui-button-group>\r\n        `;\r\n    }\r\n\r\n    override render() {\r\n        // Show controls if any culture has a validator\r\n        const shouldShowControls = Object.values(this._validationResults).some(r => r.hasValidator !== false);\r\n        \r\n        return html`\r\n            <umb-body-layout header-transparent header-fit-height>\r\n                <div style=\"display: flex; flex-direction: column; gap: var(--uui-size-layout-1);\">\r\n                    ${shouldShowControls ? html`\r\n                        <uui-box headline-variant=\"h4\">\r\n                            ${this.#renderHeader()}\r\n                            ${this.#renderControls()}\r\n                        </uui-box>\r\n                    ` : nothing}\r\n\r\n                    ${this.#renderValidationResults()}\r\n                </div>\r\n            </umb-body-layout>\r\n        `;\r\n    }\r\n\r\n    static override styles = [UmbTextStyles];\r\n}\r\n\r\nexport { CustomValidatorWorkspaceView as element };\r\n\r\ndeclare global {\r\n    interface HTMLElementTagNameMap {\r\n        'custom-validator-workspace-view': CustomValidatorWorkspaceView;\r\n    }\r\n}\r\n"],"names":["_countContext","_contentWorkspace","_currentDocumentId","_variantObserverSetup","_CustomValidatorWorkspaceView_instances","observeCounter_fn","setupWorkspaceObservers_fn","trySetupVariantObserver_fn","observeVariant_fn","getValidationKey_fn","observeDocumentChanges_fn","isDocumentSwitch_fn","clearValidationOnDocumentSwitch_fn","loadCachedValidationResult_fn","setupValidationObservers_fn","validateAndUpdateResult_fn","_handleValidateClick","_onGlobalValidateAll","getMessageCounts_fn","delay_fn","getSeverityColor_fn","renderValidationResults_fn","renderLoadingState_fn","renderSuccessMessage_fn","renderHeader_fn","renderHeaderIcon_fn","renderControls_fn","SAVE_DELAY_MS","INITIAL_VALIDATION_DELAY_MS","SEVERITY_ORDER","ValidationSeverity","SEVERITY_COLOR_MAP","validatedDocuments","CustomValidatorWorkspaceView","UmbLitElement","__privateAdd","__privateMethod","event","skipSave","VALIDATION_WORKSPACE_CONTEXT","instance","__privateSet","__privateGet","changedProperties","validationKey","hasValidatedOnce","shouldShowControls","r","html","nothing","count","UMB_CONTENT_WORKSPACE_CONTEXT","workspace","variant","newCulture","unique","isDocumentSwitch","key","newDocumentId","validationContext","error","cultures","results","culture","result","isValidating","options","performValidation","allCultures","splitView","variants","val","v","toCount","errors","warnings","m","ms","resolve","severity","toRender","sortedMessages","a","b","hasErrorsOrWarnings","repeat","msg","errorCount","UmbTextStyles","__decorateClass","state","customElement"],"mappings":";;;;;;;;;;;wXAAAA,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC;AAUA,MAAMC,KAAgB,KAChBC,KAA8B,KAG9BC,IAAqD;AAAA,EACvD,CAACC,EAAmB,KAAK,GAAG;AAAA,EAC5B,CAACA,EAAmB,OAAO,GAAG;AAAA,EAC9B,CAACA,EAAmB,IAAI,GAAG;AAC/B,GAGMC,KAAoE;AAAA,EACtE,CAACD,EAAmB,KAAK,GAAG;AAAA,EAC5B,CAACA,EAAmB,OAAO,GAAG;AAAA,EAC9B,CAACA,EAAmB,IAAI,GAAG;AAC/B,GAIME,wBAAyB,IAAA;AAMxB,IAAMC,IAAN,cAA2CC,EAAiD;AAAA,EA4B/F,cAAc;AACV,UAAA,GA7BDC,EAAA,MAAA/B,CAAA,GACH+B,EAAA,MAAAnC,CAAA,GAGA,KAAQ,QAAQ,GAMhB,KAAQ,qBAAuD,CAAA,GAM/D,KAAQ,gBAAgB,IAMxB,KAAQ,gBAAgB,IAExBmC,EAAA,MAAAlC,CAAA,GACAkC,EAAA,MAAAjC,CAAA,GACAiC,EAAA,MAAAhC,GAAwB,EAAA,GAgPxBgC,EAAA,MAAAnB,GAAuB,YAAY;AAE/B,YAAMoB,EAAA,MAAKhC,GAAAW,CAAA,EAAL,KAAA,MAA8B,EAAE,UAAU,IAAM,GAEtD,OAAO,cAAc,IAAI,YAAY,iCAAiC,EAAE,QAAQ,EAAE,UAAU,GAAA,EAAK,CAAG,CAAC;AAAA,IACzG,CAAA,GAEAoB,EAAA,MAAAlB,GAAuB,OAAOoB,MAAiB;AAE3C,UAAI,KAAK,eAAe,KAAK,aAAa;AAEtC,YAAIC,IAAW;AACf,QAAID,aAAiB,eAAe,OAAOA,EAAM,QAAQ,YAAa,cAClEC,IAAWD,EAAM,OAAO,WAE5B,MAAMD,EAAA,MAAKhC,GAAAW,CAAA,EAAL,KAAA,MAA8B,EAAE,UAAAuB,GAAS;AAAA,MACnD;AAAA,IACJ,CAAA,GA5PI,KAAK,eAAeC,GAA8B,CAACC,MAAa;AAC5D,MAAKA,MAELC,EAAA,MAAKzC,GAAgBwC,CAAA,GACrBJ,EAAA,MAAKhC,GAAAC,CAAA,EAAL,KAAA,IAAA,GACAmC,EAAS,UAAA;AAAA,IACb,CAAC,GAEDJ,EAAA,MAAKhC,GAAAE,CAAA,EAAL,KAAA,IAAA,GACA8B,EAAA,MAAKhC,GAAAU,CAAA,EAAL,KAAA,IAAA,GACA,OAAO,iBAAiB,iCAAiC4B,EAAA,MAAKzB,CAAA,CAAoB;AAAA,EACtF;AAAA,EAoIS,WAAW0B,GAAmC;AACnD,UAAM,WAAWA,CAAiB,GAG9BA,EAAkB,IAAI,mBAAmB;AAAA,EAEjD;AAAA,EAES,oBAAoB;AAKzB,QAJA,MAAM,kBAAA,GAIF,CAAC,KAAK;AACN;AAGJ,UAAMC,IAAgBR,QAAKhC,GAAAK,CAAA,EAAL,KAAA,IAAA,GAChBoC,IAAmBD,IAAgBZ,EAAmB,IAAIY,CAAa,KAAK,KAAQ;AAG1F,IAAI,KAAK,gBACAC,IAODT,EAAA,MAAKhC,GAAAW,CAAA,EAAL,KAAA,MAA8B,EAAE,UAAU,IAAK,KAN3C6B,KACAZ,EAAmB,IAAIY,GAAe,EAAI,GAG9CR,EAAA,MAAKhC,MAAL,KAAA,MAA8B,EAAE,UAAU,IAAM,UAAU,GAAA,CAAK;AAAA,EAK3E;AAAA,EAES,uBAAuB;AAC5B,UAAM,qBAAA,GACN,OAAO,oBAAoB,iCAAiCsC,EAAA,MAAKzB,CAAA,CAAoB,GAGjFyB,QAAK1C,CAAA,KACL0C,EAAA,MAAK1C,GAAc,MAAA;AAAA,EAE3B;AAAA,EAwNS,SAAS;AAEd,UAAM8C,IAAqB,OAAO,OAAO,KAAK,kBAAkB,EAAE,KAAK,CAAAC,MAAKA,EAAE,iBAAiB,EAAK;AAEpG,WAAOC;AAAA;AAAA;AAAA,sBAGOF,IAAqBE;AAAA;AAAA,8BAEbZ,EAAA,MAAKhC,MAAL,KAAA,IAAA,CAAoB;AAAA,8BACpBgC,EAAA,MAAKhC,MAAL,KAAA,IAAA,CAAsB;AAAA;AAAA,wBAE5B6C,CAAO;AAAA;AAAA,sBAETb,EAAA,MAAKhC,MAAL,KAAA,IAAA,CAA+B;AAAA;AAAA;AAAA;AAAA,EAIjD;AAGJ;AApcIJ,IAAA,oBAAA,QAAA;AAuBAC,IAAA,oBAAA,QAAA;AACAC,IAAA,oBAAA,QAAA;AACAC,IAAA,oBAAA,QAAA;AA1BGC,IAAA,oBAAA,QAAA;AA4CHC,IAAe,WAAS;AACpB,EAAKqC,QAAK1C,CAAA,KACV,KAAK,QAAQ0C,EAAA,MAAK1C,CAAA,EAAc,SAAS,CAACkD,MAAU;AAEhD,SAAK,QAAQA,IAAQ,GACrB,QAAQ,IAAI,mBAAmB,KAAK,OAAO,kBAAkBA,IAAQ,GAAG,GAGxEd,EAAA,MAAKhC,GAAAG,CAAA,EAAL,KAAA,IAAA;AAAA,EACJ,CAAC;AACL;AAEAD,IAAwB,WAAG;AACvB,OAAK,eAAe6C,IAA+B,CAACC,MAAc;AAC9D,IAAKA,MACLX,EAAA,MAAKxC,GAAoBmD,CAAA,GACzBhB,EAAA,MAAKhC,MAAL,KAAA,MAA6BgD,CAAA,GAG7BhB,EAAA,MAAKhC,GAAAG,CAAA,EAAL,KAAA,IAAA;AAAA,EACJ,CAAC;AACL;AAEAA,IAAwB,WAAG;AAEvB,EAAImC,QAAKvC,CAAA,KAAyB,CAACuC,QAAKzC,CAAA,KAAqB,KAAK,QAAQ,MAI1EwC,EAAA,MAAKtC,GAAwB,EAAA,GAC7B,QAAQ,IAAI,6CAA6C,KAAK,KAAK,GACnEiC,EAAA,MAAKhC,GAAAI,CAAA,EAAL,WAAqBkC,EAAA,MAAKzC,CAAA,CAAA;AAC9B;AAEAO,IAAe,SAAC4C,GAAsD;AAClE,UAAQ,IAAI,+BAA+B,KAAK,KAAK,GAGrD,KAAK;AAAA,IACDA,EAAU,UAAU,qBAAqB,KAAK,KAAK;AAAA,IACnD,OAAOC,MAAY;AACf,YAAMC,IAAaD,GAAS,WAAW;AACvC,cAAQ,IAAI,YAAY,KAAK,KAAK,eAAeC,GAAY,YAAYD,CAAO,GAG5E,KAAK,oBAAoBC,KACzB,KAAK,kBAAkBA,GACvB,KAAK,gBAAgB,IACrB,MAAMlB,QAAKhC,GAAAS,CAAA,EAAL,KAAA,IAAA,KACE,KAAK,kBACb,KAAK,gBAAgB;AAAA,IAE7B;AAAA,EAAA;AAER;AAEAJ,IAAiB,WAAuB;AAEpC,MAAK,KAAK;AACV,WAAO,GAAG,KAAK,WAAW,IAAI,KAAK,mBAAmB,WAAW;AACrE;AAEAC,IAAuB,SAAC0C,GAAsD;AAC1E,OAAK;AAAA,IACDA,EAAU;AAAA,IACV,OAAOG,MAAW;AACd,YAAMC,IAAmBpB,EAAA,MAAKhC,GAAAO,CAAA,EAAL,KAAA,MAAuB4C,CAAA;AAEhD,WAAK,cAAcA,KAAU,QAC7Bd,EAAA,MAAKvC,GAAqBqD,KAAU,MAAA,GAGpC,MAAMnB,QAAKhC,GAAAQ,CAAA,EAAL,KAAA,IAAA,GAGF4C,KAAoBD,KAEC,MAAM,KAAKvB,EAAmB,MAAM,EAAE,OAAO,CAAAyB,MAAOA,EAAI,WAAW,GAAGF,CAAM,GAAG,CAAC,EACxF,QAAQ,CAAAE,MAAOzB,EAAmB,OAAOyB,CAAG,CAAC;AAAA,IAElE;AAAA,EAAA;AAER;AAEA9C,IAAiB,SAAC+C,GAAmD;AACjE,SAAOhB,EAAA,MAAKxC,CAAA,MAAuB,UAAawC,EAAA,MAAKxC,CAAA,MAAuBwD;AAChF;AAEM9C,IAAgC,iBAAG;AACrC,MAAI;AACA,UAAM+C,IAAoB,MAAM,KAAK,WAAWpB,CAA4B;AAC5E,IAAIoB,KACAA,EAAkB,gBAAA;AAAA,EAE1B,SAASC,GAAO;AACZ,YAAQ,MAAM,kDAAkDA,CAAK;AAAA,EACzE;AACJ;AAEM/C,IAA2B,iBAAG;AAChC,MAAI;AACA,UAAM8C,IAAoB,MAAM,KAAK,WAAWpB,CAA4B;AAC5E,QAAIoB,GAAmB;AAEnB,YAAME,IAAW,OAAO,KAAK,KAAK,kBAAkB,GAC9CC,IAA4C,CAAA;AAClD,iBAAWC,KAAWF,GAAU;AAC5B,cAAMG,IAASL,EAAkB,oBAAoBI,MAAY,YAAY,SAAYA,CAAO;AAChG,QAAIC,MAAQF,EAAQC,CAAO,IAAIC;AAAA,MACnC;AACA,WAAK,qBAAqBF;AAAA,IAC9B;AAAA,EACJ,SAASF,GAAO;AACZ,YAAQ,MAAM,4CAA4CA,CAAK;AAAA,EACnE;AACJ;AAEA9C,IAAyB,WAAG;AACxB,OAAK,eAAeyB,GAA8B,CAACoB,MAAsB;AACrE,IAAKA,KAEL,KAAK;AAAA,MACDA,EAAkB;AAAA,MAClB,CAACM,MAAiB;AACd,aAAK,gBAAgBA;AAAA,MACzB;AAAA,IAAA;AAAA,EAER,CAAC;AACL;AA+CMlD,IAAwB,eAACmD,IAAsD,IAAI;AACrF,MAAK,KAAK;AAEV,QAAI;AACA,YAAMP,IAAoB,MAAM,KAAK,WAAWpB,CAA4B;AAC5E,UAAI,CAACoB,EAAmB;AAExB,YAAMQ,IAAoB,YAAY;AAClC,YAAI;AAEA,UAAI,CAACD,EAAQ,YAAYxB,EAAA,MAAKzC,IAAmB,kBAC7C,MAAMyC,EAAA,MAAKzC,GAAkB,cAAA,GAC7B,MAAMmC,EAAA,MAAKhC,MAAL,KAAA,MAAYuB,EAAA;AAItB,cAAIyC;AACJ,gBAAMC,IAAY3B,QAAKzC,CAAA,GAAmB;AAC1C,cAAIqE,IAAkB,CAAA;AACtB,UAAID,KAAa,OAAOA,EAAU,mBAAmB,aAAc,cAE/DA,EAAU,mBAAmB,UAAU,CAACE,MAAe;AAAE,YAAAD,IAAWC;AAAA,UAAK,CAAC,GAE1ED,EAAS,SAAS,MAClBF,IAAcE,EAAS,IAAI,CAACE,MAAWA,EAAE,WAAW,MAAS;AAGjE,gBAAMV,IAAU,MAAMH,EAAkB,iBAAiB,KAAK,aAAc,KAAK,iBAAiBS,CAAW;AAC7G,eAAK,qBAAqBN,GAE1B,KAAK,iBAAiB,KAAK,mBAAmB;AAAA,QAClD,SAASF,GAAO;AACZ,kBAAQ,MAAM,uBAAuBA,CAAK;AAAA,QAC9C;AAAA,MACJ;AAGA,MAAIM,EAAQ,YACR,MAAM9B,EAAA,MAAKhC,MAAL,KAAA,MAAYwB,EAAA,GAGtB,MAAMuC,EAAA;AAAA,IACV,SAASP,GAAO;AACZ,cAAQ,MAAM,yCAAyCA,CAAK;AAAA,IAChE;AACJ;AAEA5C,IAAA,oBAAA,QAAA;AAOAC,IAAA,oBAAA,QAAA;AAYAC,IAAiB,SAAC2C,GAA2D;AAEzE,QAAMY,IAAUZ,KAAYA,EAAS,SAAS,IAAIA,IAAW,OAAO,KAAK,KAAK,kBAAkB;AAChG,MAAIa,IAAS,GACTC,IAAW;AACf,aAAWZ,KAAWU,GAAS;AAC3B,UAAMT,IAAS,KAAK,mBAAmBD,CAAO;AAC9C,IAAIC,MACAU,KAAUV,EAAO,SAAS,OAAO,CAACY,MAAyBA,EAAE,aAAa9C,EAAmB,KAAK,EAAE,QACpG6C,KAAYX,EAAO,SAAS,OAAO,CAACY,MAAyBA,EAAE,aAAa9C,EAAmB,OAAO,EAAE;AAAA,EAEhH;AACA,SAAO,EAAE,QAAA4C,GAAQ,UAAAC,EAAA;AACrB;AAEAxD,IAAM,SAAC0D,GAA2B;AAC9B,SAAO,IAAI,QAAQ,CAAAC,MAAW,WAAWA,GAASD,CAAE,CAAC;AACzD;AAEAzD,IAAiB,SAAC2D,GAAiD;AAC/D,SAAOhD,GAAmBgD,CAAQ;AACtC;AAEA1D,IAAwB,WAAG;AACvB,MAAI,KAAK;AACL,WAAOe,QAAKhC,GAAAkB,CAAA,EAAL,KAAA,IAAA;AAEX,QAAMuC,IAAW,OAAO,KAAK,KAAK,kBAAkB;AACpD,MAAIA,EAAS,WAAW;AACpB,WAAOzB,QAAKhC,GAAAkB,CAAA,EAAL,KAAA,IAAA;AAGX,QAAM0D,IAAWnB,EAAS,SAAS,IAAIA,IAAW,CAAC,KAAK,kBAAkB,SAAS;AACnF,SAAOb;AAAA;AAAA,kBAEGgC,EAAS,IAAI,CAAAjB,MAAW;AACtB,UAAMC,IAAS,KAAK,mBAAmBD,CAAO;AAC9C,QAAI,CAACC,EAAQ,QAAOf;AACpB,QAAI,CAACe,EAAO;AACR,aAAOhB;AAAA;AAAA;AAAA;AAKX,UAAMiC,IAAiB,CAAC,GAAGjB,EAAO,QAAQ,EAAE,KAAK,CAACkB,GAAGC,MAAMtD,EAAeqD,EAAE,QAAQ,IAAIrD,EAAesD,EAAE,QAAQ,CAAC,GAC5GC,IAAsBpB,EAAO,SAAS,KAAK,CAAAY,MAAKA,EAAE,aAAa9C,EAAmB,SAAS8C,EAAE,aAAa9C,EAAmB,OAAO;AAC1I,WAAOkB;AAAA;AAAA;AAAA,8BAGGe,MAAY,YAAYf;AAAA;AAAA,8EAEwBe,CAAO;AAAA,0CAEvDd,CAAO;AAAA;AAAA,8BAENmC,IAAqDnC,IAA/Bb,EAAA,MAAKhC,GAAAmB,CAAA,EAAL,UAAsC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kCAMzD8D;AAAA,MACEJ;AAAA,MACA,CAACK,MAAQA,EAAI;AAAA,MACb,CAACA,MAAQtC;AAAA;AAAA;AAAA,iEAGoBZ,EAAA,MAAKhC,GAAAgB,CAAA,EAAL,KAAA,MAAuBkE,EAAI,QAAA,CAAS;AAAA,sDAC/CA,EAAI,QAAQ;AAAA;AAAA;AAAA,8DAGJA,EAAI,OAAO;AAAA;AAAA;AAAA,IAAA,CAGxC;AAAA;AAAA;AAAA;AAAA,EAIjB,CAAC,CAAC;AAAA;AAAA;AAGd;AAEAhE,IAAmB,WAAG;AAClB,SAAO0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQX;AAEAzB,IAAqB,WAAG;AACpB,SAAOyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAMX;AAEAxB,IAAa,WAAG;AAEZ,QAAMqC,IAAW,OAAO,KAAK,KAAK,kBAAkB,GAC9CmB,IAAWnB,EAAS,SAAS,IAAIA,IAAW,CAAC,KAAK,kBAAkB,SAAS,GAC7E,EAAE,QAAAa,GAAQ,UAAAC,EAAA,IAAavC,EAAA,MAAKhC,MAAL,KAAA,MAAuB4E,CAAA;AAEpD,SAAOhC;AAAA;AAAA,kBAEGZ,EAAA,MAAKhC,GAAAqB,CAAA,EAAL,KAAA,MAAuBiD,CAAA,CAAO;AAAA;AAAA;AAAA;AAAA,kBAI9BA,IAAS,IAAI1B;AAAA,6DAC8B0B,CAAM;AAAA,oBAC/CzB,CAAO;AAAA,kBACT0B,IAAW,IAAI3B;AAAA,8DAC6B2B,CAAQ;AAAA,oBAClD1B,CAAO;AAAA;AAAA;AAGvB;AAEAxB,IAAiB,SAAC8D,GAAoB;AAClC,SAAOA,IAAa,IACdvC,sFACAA;AACV;AAEAtB,IAAe,WAAG;AACd,SAAOsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAMcN,QAAK1B,CAAA,CAAoB;AAAA,gCACtB,CAAC,KAAK,eAAe,KAAK,aAAa;AAAA;AAAA;AAAA,kBAGrD,KAAK,gBAAgBgC,+BAAkCC,CAAO;AAAA;AAAA;AAG5E;AA9aShB,EAocO,SAAS,CAACuD,CAAa;AAhc/BC,EAAA;AAAA,EADPC,EAAA;AAAM,GAHEzD,EAID,WAAA,SAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GANEzD,EAOD,WAAA,eAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GATEzD,EAUD,WAAA,sBAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GAZEzD,EAaD,WAAA,kBAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GAfEzD,EAgBD,WAAA,iBAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GAlBEzD,EAmBD,WAAA,mBAAA,CAAA;AAGAwD,EAAA;AAAA,EADPC,EAAA;AAAM,GArBEzD,EAsBD,WAAA,iBAAA,CAAA;AAtBCA,IAANwD,EAAA;AAAA,EADNE,EAAc,iCAAiC;AAAA,GACnC1D,CAAA;"}