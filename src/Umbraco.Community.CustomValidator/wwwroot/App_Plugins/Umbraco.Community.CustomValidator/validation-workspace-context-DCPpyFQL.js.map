{"version":3,"file":"validation-workspace-context-DCPpyFQL.js","sources":["../../../Client/src/validation/validation-api.service.ts","../../../Client/src/validation/types.ts","../../../Client/src/validation/validation-workspace-context.ts"],"sourcesContent":["import type { ValidationResult } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\n\r\nexport class ValidationApiService extends UmbControllerBase {\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n    }\r\n\r\n    async validateDocument(id: string, culture?: string): Promise<ValidationResult> {\r\n        try {\r\n            const authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n            const token = await authContext?.getLatestToken();\r\n\r\n            const url = new URL(`/umbraco/management/api/v1/validation/validate/${id}`, window.location.origin);\r\n            if (culture) {\r\n                url.searchParams.append('culture', culture);\r\n            }\r\n\r\n            const response = await fetch(url.toString(), {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Authorization': `Bearer ${token}`,\r\n                    'Content-Type': 'application/json',\r\n                },\r\n            });\r\n\r\n            if (!response.ok) {\r\n                // Try to parse error message from response (supports both ProblemDetails and custom formats)\r\n                let errorMessage = `Validation request failed: ${response.status} ${response.statusText}`;\r\n                try {\r\n                    const errorData = await response.json();\r\n                    // Check for ProblemDetails format (detail/title) or custom format (message)\r\n                    if (errorData.detail) {\r\n                        errorMessage = errorData.detail;\r\n                    } else if (errorData.title) {\r\n                        errorMessage = errorData.title;\r\n                    } else if (errorData.message) {\r\n                        errorMessage = errorData.message;\r\n                    }\r\n                } catch {\r\n                    // If parsing fails, use default message\r\n                }\r\n                throw new Error(errorMessage);\r\n            }\r\n\r\n            const result = await response.json();\r\n            \r\n            // Ensure we always return a valid ValidationResult\r\n            return result || {\r\n                contentId: id,\r\n                contentTypeAlias: '',\r\n                hasValidator: false,\r\n                messages: []\r\n            };\r\n        } catch (error) {\r\n            // Re-throw with more context\r\n            if (error instanceof Error) {\r\n                throw new Error(`Failed to validate document: ${error.message}`);\r\n            }\r\n            throw new Error('Failed to validate document: Unknown error');\r\n        }\r\n    }\r\n}\r\n","// Enum for validation severity levels to match backend\r\nexport enum ValidationSeverity {\r\n    Error = 'Error',\r\n    Warning = 'Warning',\r\n    Info = 'Info'\r\n}\r\n\r\n// Type-safe literal types for notification colors\r\nexport type NotificationColor = 'danger' | 'warning' | 'default' | 'positive';\r\n\r\nexport interface ValidationMessage {\r\n    message: string;\r\n    severity: ValidationSeverity;\r\n}\r\n\r\nexport interface ValidationResult {\r\n    contentId: string;\r\n    contentTypeAlias: string;\r\n    hasValidator: boolean;\r\n    messages: ValidationMessage[];\r\n}\r\n","import { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { ValidationApiService } from './validation-api.service.js';\r\nimport type { ValidationResult } from './types.js';\r\nimport { ValidationSeverity } from './types.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport { UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport const VALIDATION_WORKSPACE_CONTEXT = new UmbContextToken<ValidationWorkspaceContext>(\r\n    'ValidationWorkspaceContext'\r\n);\r\n\r\nexport class ValidationWorkspaceContext extends UmbControllerBase {\r\n    #apiService = new ValidationApiService(this);\r\n    #validationResults = new Map<string, ValidationResult>();\r\n    #isValidating = new UmbObjectState<boolean>(false);\r\n\r\n    public readonly isValidating = this.#isValidating.asObservable();\r\n\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n\r\n        this.provideContext(VALIDATION_WORKSPACE_CONTEXT, this);\r\n    }\r\n\r\n    async validateManually(documentId: string, culture?: string) {\r\n        this.#isValidating.setValue(true);\r\n\r\n        try {\r\n            const result = await this.#apiService.validateDocument(documentId, culture);\r\n            // Store result per culture\r\n            const cultureKey = culture || 'default';\r\n            this.#validationResults.set(cultureKey, result);\r\n            return result;\r\n        } catch (error) {\r\n            console.error('Manual validation failed:', error);\r\n            throw error;\r\n        } finally {\r\n            this.#isValidating.setValue(false);\r\n        }\r\n    }\r\n\r\n    getValidationResult(culture?: string): ValidationResult | undefined {\r\n        const cultureKey = culture || 'default';\r\n        return this.#validationResults.get(cultureKey);\r\n    }\r\n\r\n    getLastValidationResult(): ValidationResult | undefined {\r\n        // Return any available result\r\n        return Array.from(this.#validationResults.values())[0];\r\n    }\r\n\r\n    hasBlockingErrors(culture?: string): boolean {\r\n        const cultureKey = culture || 'default';\r\n        const result = this.#validationResults.get(cultureKey);\r\n        if (!result) return false;\r\n        return result.messages.some(m => m.severity === ValidationSeverity.Error);\r\n    }\r\n\r\n    clearValidation() {\r\n        this.#validationResults.clear();\r\n    }\r\n}\r\n\r\nexport { ValidationWorkspaceContext as api };\r\n"],"names":["ValidationApiService","UmbControllerBase","host","id","culture","token","UMB_AUTH_CONTEXT","url","response","errorMessage","errorData","error","ValidationSeverity","VALIDATION_WORKSPACE_CONTEXT","UmbContextToken","ValidationWorkspaceContext","#apiService","#validationResults","#isValidating","UmbObjectState","documentId","result","cultureKey","m"],"mappings":"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"}