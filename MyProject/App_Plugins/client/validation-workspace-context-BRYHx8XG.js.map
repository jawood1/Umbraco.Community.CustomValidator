{"version":3,"file":"validation-workspace-context-BRYHx8XG.js","sources":["../../TestExtension/client/src/validation/validation-api.service.ts","../../TestExtension/client/src/validation/validation-workspace-context.ts"],"sourcesContent":["import type { ValidationResult } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\n\r\nexport class ValidationApiService extends UmbControllerBase {\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n    }\r\n\r\n    async validateDocument(id: string, culture?: string): Promise<ValidationResult> {\r\n        const authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n        const token = await authContext?.getLatestToken();\r\n\r\n        const url = new URL(`/umbraco/management/api/v1/validation/validate/${id}`, window.location.origin);\r\n        if (culture) {\r\n            url.searchParams.append('culture', culture);\r\n        }\r\n\r\n        const response = await fetch(url.toString(), {\r\n            method: 'GET',\r\n            headers: {\r\n                'Authorization': `Bearer ${token}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Validation request failed: ${response.statusText}`);\r\n        }\r\n\r\n        return await response.json();\r\n    }\r\n}\r\n","import { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { ValidationApiService } from './validation-api.service.js';\r\nimport type { ValidationResult } from './types.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport { UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport const VALIDATION_WORKSPACE_CONTEXT = new UmbContextToken<ValidationWorkspaceContext>(\r\n    'ValidationWorkspaceContext'\r\n);\r\n\r\nexport class ValidationWorkspaceContext extends UmbControllerBase {\r\n    #apiService = new ValidationApiService(this);\r\n    #validationResult = new UmbObjectState<ValidationResult | undefined>(undefined);\r\n    #isValidating = new UmbObjectState<boolean>(false);\r\n\r\n    public readonly validationResult = this.#validationResult.asObservable();\r\n    public readonly isValidating = this.#isValidating.asObservable();\r\n\r\n    constructor(host: UmbControllerHost) {\r\n        super(host);\r\n\r\n        this.provideContext(VALIDATION_WORKSPACE_CONTEXT, this);\r\n    }\r\n\r\n    async validateManually(documentId: string, culture?: string) {\r\n        this.#isValidating.setValue(true);\r\n\r\n        try {\r\n            const result = await this.#apiService.validateDocument(documentId, culture);\r\n            this.#validationResult.setValue(result);\r\n            return result;\r\n        } catch (error) {\r\n            console.error('Manual validation failed:', error);\r\n            throw error;\r\n        } finally {\r\n            this.#isValidating.setValue(false);\r\n        }\r\n    }\r\n\r\n    getLastValidationResult(): ValidationResult | undefined {\r\n        return this.#validationResult.getValue();\r\n    }\r\n\r\n    hasBlockingErrors(): boolean {\r\n        const result = this.#validationResult.getValue();\r\n        if (!result) return false;\r\n        return result.messages.some(m => m.severity === 'Error');\r\n    }\r\n\r\n    clearValidation() {\r\n        this.#validationResult.setValue(undefined);\r\n    }\r\n}\r\n\r\nexport { ValidationWorkspaceContext as api };\r\n"],"names":["ValidationApiService","UmbControllerBase","host","id","culture","token","UMB_AUTH_CONTEXT","url","response","VALIDATION_WORKSPACE_CONTEXT","UmbContextToken","ValidationWorkspaceContext","#apiService","#validationResult","UmbObjectState","#isValidating","documentId","result","error","m"],"mappings":";;;;AAKO,MAAMA,UAA6BC,EAAkB;AAAA,EACxD,YAAYC,GAAyB;AACjC,UAAMA,CAAI;AAAA,EACd;AAAA,EAEA,MAAM,iBAAiBC,GAAYC,GAA6C;AAE5E,UAAMC,IAAQ,OADM,MAAM,KAAK,WAAWC,CAAgB,IACzB,eAAA,GAE3BC,IAAM,IAAI,IAAI,kDAAkDJ,CAAE,IAAI,OAAO,SAAS,MAAM;AAClG,IAAIC,KACAG,EAAI,aAAa,OAAO,WAAWH,CAAO;AAG9C,UAAMI,IAAW,MAAM,MAAMD,EAAI,YAAY;AAAA,MACzC,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,eAAiB,UAAUF,CAAK;AAAA,QAChC,gBAAgB;AAAA,MAAA;AAAA,IACpB,CACH;AAED,QAAI,CAACG,EAAS;AACV,YAAM,IAAI,MAAM,8BAA8BA,EAAS,UAAU,EAAE;AAGvE,WAAO,MAAMA,EAAS,KAAA;AAAA,EAC1B;AACJ;AC1BO,MAAMC,IAA+B,IAAIC;AAAA,EAC5C;AACJ;AAEO,MAAMC,UAAmCV,EAAkB;AAAA,EAQ9D,YAAYC,GAAyB;AACjC,UAAMA,CAAI,GARd,KAAAU,KAAc,IAAIZ,EAAqB,IAAI,GAC3C,KAAAa,KAAoB,IAAIC,EAA6C,MAAS,GAC9E,KAAAC,KAAgB,IAAID,EAAwB,EAAK,GAEjD,KAAgB,mBAAmB,KAAKD,GAAkB,aAAA,GAC1D,KAAgB,eAAe,KAAKE,GAAc,aAAA,GAK9C,KAAK,eAAeN,GAA8B,IAAI;AAAA,EAC1D;AAAA,EAXAG;AAAA,EACAC;AAAA,EACAE;AAAA,EAWA,MAAM,iBAAiBC,GAAoBZ,GAAkB;AACzD,SAAKW,GAAc,SAAS,EAAI;AAEhC,QAAI;AACA,YAAME,IAAS,MAAM,KAAKL,GAAY,iBAAiBI,GAAYZ,CAAO;AAC1E,kBAAKS,GAAkB,SAASI,CAAM,GAC/BA;AAAA,IACX,SAASC,GAAO;AACZ,oBAAQ,MAAM,6BAA6BA,CAAK,GAC1CA;AAAA,IACV,UAAA;AACI,WAAKH,GAAc,SAAS,EAAK;AAAA,IACrC;AAAA,EACJ;AAAA,EAEA,0BAAwD;AACpD,WAAO,KAAKF,GAAkB,SAAA;AAAA,EAClC;AAAA,EAEA,oBAA6B;AACzB,UAAMI,IAAS,KAAKJ,GAAkB,SAAA;AACtC,WAAKI,IACEA,EAAO,SAAS,KAAK,CAAAE,MAAKA,EAAE,aAAa,OAAO,IADnC;AAAA,EAExB;AAAA,EAEA,kBAAkB;AACd,SAAKN,GAAkB,SAAS,MAAS;AAAA,EAC7C;AACJ;"}